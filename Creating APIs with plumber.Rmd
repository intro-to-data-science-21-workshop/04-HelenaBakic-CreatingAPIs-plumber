---
title: "Creating web APIs with plumber"
author: "Helena Bakic & Katalin Bayer"
date: "04/11/2021"
institute: "Hertie School"
output:
  xaringan::moon_reader:
    css: [default, metropolis, metropolis-fonts]
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
      ratio: '16:9'
      hash: true
---

```{r setup, include=FALSE}

# figures formatting setup
options(htmltools.dir.version = FALSE)
library(knitr)
opts_chunk$set(
  prompt = T,
  fig.align="center", #fig.width=6, fig.height=4.5, 
  # out.width="748px", #out.length="520.75px",
  dpi=300, #fig.path='Figs/',
  cache=T, #echo=F, warning=F, message=F
  engine.opts = list(bash = "-l")
  )

knitr::opts_chunk$set(eval = FALSE)

```

# Table of contents
1. [Topic 1](#topic1)
2. [Topic 2](#topic2)

---
class: inverse, center, middle
name: topic1

#Topic 1

---
#Quick intro to APIs

.pull-left[
##What are APIs?

API (Application Programming Interface) is a set of rules on how computers or applications communicate with one another.

**Metaphor:** Electric sockets are interfaces to access a service -- a socket is an intermediary between electricity and a vacuum cleaner.<sup>1</sup>

**Everyday APIs:**
- web browsers 
- login with Google/Twitter/Facebook
- travel booking (e.g. Skyscanner)
- every time we see a Google map on a web site

]

.pull-right[
##How do (web) APIs work?

1. A **client** initiates an API call (**request**) to retrieve information 
2. API "talks" to a web server
3. A **server** sends a **response** with the requested information
4. API transfers the data to the client

<div align="left">
<img src="pics/API.png" height=200>
</div>
`Credit` Seobility
]

.footnote[<sup>1</sup> This example was modified from [David Berlind's series on APIs](https://www.programmableweb.com/api-university/what-are-apis-and-how-do-they-work)]

---
#Quick intro to APIs

##Why do we need them?

Electric sockets are useful because:
- any device can outsource its electrical requirements and always get the same output
- devices can easily be moved around
- devices do not care about the changes behind the socket as long as the output remains the same
- electricity service does not care about the device

APIs are useful because:
- code/data can be easily shared and re/used
- information can be shared across multiple clients and will not depend on the programming language

---
#The Plumber package

.pull-left[

The `plumber` R package allows users to expose existing R code as a web service available to others by using simple "annotations".

How to work with `plumber`:
0. Write the code you want to share
1. Annotate (**decorate**) your code with special comments (#*) and tags (@)
2. Run (**plumb**) the API
3. (Deploy your API)

<br>
<div align="justify">
<img src="pics/plumber-icon.jpg" height=150>
</div>


]

.pull-right[

<br> 
<div align="center">
<img src="pics/windows-pipes.gif" height=400>
</div>
`Credit` Windows 95

]

---
#The Plumber package

<br> 
<div align="center">
<img src="pics/api-video.gif" height=400>
</div>


---
#Plumber annotations

.pull-left[

<div align="center">
<img src="pics/api-example.png" height=550>
</div>

]

.pull-right[

Annotations are specially-structured comments used to create an API. A full annotation line starts with `#*`, followed by the annotation keyword `@`.

**Types of annotations:**

- Global annotations: describe the API (e.g. `@apiTitle`, `@apiDescription`)
- Filter annotation: defines a filter (`@filter [name]`)
- Endpoint annotation:
  - `@parser [parser name]` determines how to parse the request body 
  - method (e.g.`@get [path]`) responds to incoming requests that match the defined method
  - `@param [name]` determines API inputs
  - `@serializer [serializer name]` determines the format of the response

]


---
#Filters

Filters are used to handle/modify incoming requests. Typically, a request will pass every specified filter before going to the endpoint. Common uses are collecting information about incoming requests and authentication.

.pull-left[

**Request logger:**

``` {r}
#* @filter logger
function(req, res){
  cat(as.character(Sys.time()), "-",
      req$REQUEST_METHOD, req$PATH_INFO, "-",
      req$HTTP_USER_AGENT, "@", req$REMOTE_ADDR, "\n", append=TRUE, file="api_logs.txt")
  plumber::forward()
}
```

Log file:
```{r, eval=TRUE, echo=FALSE, fig.width=5}
v <- scan("./example/api_logs.txt", what = " ", sep = "\n")
paste0("number of entries: ",length(v))
v[1:3]
```
]



.pull-right[

**Authentication:**

```{r }
#* @filter checkAuth
function(req, res){
  if (is.null(req$username)){
    res$status <- 401 # Unauthorized
    return(list(error="Authentication required"))
  } else {
    plumber::forward()
  }
}
```

`{"error":["Authentication required"]}`

]

---
#Parsers and serializers

(default: JSON<sup>2</sup>)

.footnote[<sup>2</sup> JavaScript Object notation]

---
#Methods


---
#Parameters


---
#Deploying APIs

---
#Where to go next?

.pull-left[

Some additional resources:

- [Plumber documentation](https://www.rplumber.io/index.html) 
- [API examples with Plumber](https://github.com/sol-eng/plumberExamples) 
- [Plumber cheatsheat](https://github.com/rstudio/cheatsheets/blob/master/plumber.pdf)

More advanced topics & examples:
1. Security: see [Plumber  documentation](https://www.rplumber.io/articles/security.html)


]

.pull-right[

<br>
<div align="center">
<img src="pics/matrix.gif" height=400>
</div>


]


